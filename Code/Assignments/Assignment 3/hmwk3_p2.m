EA = 2100;
L1_vec = [5.5; 0.5];
L2_vec = [-4.0; 0.5];
L1 = sqrt(dot(L1_vec,L1_vec));
L2 = sqrt(dot(L2_vec,L2_vec));
n1 = L1_vec/L1;
n2 = L2_vec/L2;
K1 = EA/L1 * n1*n1';
K2 = EA/L2 * n2*n2';
Ktot = K1 + K2;
Pcr = [0;-.999];

R = [0;0];
vo = Ktot\R;
v1 = Ktot\Pcr;
vn = [0;0];
gamman = 0;
g = 0;
alpha = 0.00;
s= 0;

v_tot = {};
gamma_tot = zeros();
Fy = zeros();
arclength = zeros();
normR = zeros();
Residuals = zeros();

gamma_tot(1) = gamman;
v_tot{1} = vn;


for i = 2:60
    if i == 2
        gamma = gamman + .2;
        v = vn + v1*.2;
        ds2 = dot(v-vn,v-vn) + alpha*(gamma-gamman)^2;
        ds = sqrt(ds2);
    else
        v = 2*v_tot{end} - v_tot{end-1};
        gamma = 2*gamma_tot(end) - gamma_tot(end-1);
    end

    
    for j = 1:10
        l1_vec = L1_vec + v;
        l2_vec = L2_vec + v;
        l1 = sqrt(dot(l1_vec,l1_vec));
        l2 = sqrt(dot(l2_vec,l2_vec));
        n1 = l1_vec/l1;
        n2 = l2_vec/l2;
        lambda1 = l1/L1;
        lambda2 = l2/L2;
        strain1 = log(lambda1);
        strain2 = log(lambda2);
        f1 = EA*strain1;
        f2 = EA*strain2;
        Ftot = f1*n1 + f2*n2;

        R = -Ftot + Pcr*gamma;
        
        change_v = v-vn;
        change_gamma = gamma - gamman;
        g = -ds2 + dot(change_v,change_v) + alpha*change_gamma^2;
        
        Rtot = [R;g];
        check = norm(Rtot);
        Residuals(j,i) = check;

        if norm(Rtot) < 1e-10
           break
        end
        
        I = eye(2);
        k11 = EA/l1 * (n1*n1');
        k12 = f1/l1 * (I-n1*n1');
        k21 = EA/l2 * (n2*n2');
        k22 = f2/l2 * (I-n2*n2');
        ktot = k11 + k12 + k21 + k22;

        vo = ktot\R;
        v1 = ktot\Pcr;
        dgamma = -(g+2*dot(change_v,vo))/(2*dot(change_v,v1) + 2*alpha*change_gamma);
        dv = vo + v1*dgamma;
        gamma = gamma + dgamma;
        v = v + dv;

    end
    v_tot{i} = v;
    gamma_tot(i) = gamma;
    arclength(i) = s+ds;
    normR(i) = check;
    s = s + ds;
    gamman = gamma;
    vn = v;
    K = ktot;
end

% copy and pasted from previous homework, I'm sorry
v_values = cell2mat(v_tot);
vtot_hw2 = [-0.0100000000000000,-0.0200000000000000,-0.0300000000000000,-0.0400000000000000,-0.0500000000000000,-0.0600000000000000,-0.0700000000000000,-0.0800000000000000,-0.0900000000000000,-0.100000000000000,-0.110000000000000,-0.120000000000000,-0.130000000000000,-0.140000000000000,-0.150000000000000,-0.160000000000000,-0.170000000000000,-0.180000000000000,-0.190000000000000,-0.200000000000000,-0.210000000000000,-0.220000000000000,-0.230000000000000,-0.240000000000000,-0.250000000000000,-0.260000000000000,-0.270000000000000,-0.280000000000000,-0.290000000000000,-0.300000000000000,-0.310000000000000,-0.320000000000000,-0.330000000000000,-0.340000000000000,-0.350000000000000,-0.360000000000000,-0.370000000000000,-0.380000000000000,-0.390000000000000,-0.400000000000000,-0.410000000000000,-0.420000000000000,-0.430000000000000,-0.440000000000000,-0.450000000000000,-0.460000000000000,-0.470000000000000,-0.480000000000000,-0.490000000000000,-0.500000000000000,-0.510000000000000,-0.520000000000000,-0.530000000000000,-0.540000000000000,-0.550000000000000,-0.560000000000000,-0.570000000000000,-0.580000000000000,-0.590000000000000,-0.600000000000000,-0.610000000000000,-0.620000000000000,-0.630000000000000,-0.640000000000000,-0.650000000000000,-0.660000000000000,-0.670000000000000,-0.680000000000000,-0.690000000000000,-0.700000000000000,-0.710000000000000,-0.720000000000000,-0.730000000000000,-0.740000000000000,-0.750000000000000,-0.760000000000000,-0.770000000000000,-0.780000000000000,-0.790000000000000,-0.800000000000000,-0.810000000000000,-0.820000000000000,-0.830000000000000,-0.840000000000000,-0.850000000000000,-0.860000000000000,-0.870000000000000,-0.880000000000000,-0.890000000000000,-0.900000000000000,-0.910000000000000,-0.920000000000000,-0.930000000000000,-0.940000000000000,-0.950000000000000,-0.960000000000000,-0.970000000000000,-0.980000000000000,-0.990000000000000,-1,-1.01000000000000,-1.02000000000000,-1.03000000000000,-1.04000000000000,-1.05000000000000,-1.06000000000000,-1.07000000000000,-1.08000000000000,-1.09000000000000,-1.10000000000000,-1.11000000000000,-1.12000000000000,-1.13000000000000,-1.14000000000000,-1.15000000000000,-1.16000000000000,-1.17000000000000,-1.18000000000000,-1.19000000000000,-1.20000000000000];
utot_hw2 = [-0.000331878754059198,-0.000657195718521754,-0.000975938763883156,-0.00128809942756556,-0.00159366943657948,-0.00189264070675411,-0.00218500534205277,-0.00247075563389386,-0.00274988406049341,-0.00302238328621170,-0.00328824616092350,-0.00354746571938381,-0.00380003518062963,-0.00404594794737647,-0.00428519760543942,-0.00451777792315874,-0.00474368285085073,-0.00496290652026329,-0.00517544324405021,-0.00538128751525717,-0.00558043400682391,-0.00577287757110200,-0.00595861323938453,-0.00613763622145391,-0.00630994190513769,-0.00647552585589196,-0.00663438381638466,-0.00678651170610846,-0.00693190562099650,-0.00707056183306471,-0.00720247679005901,-0.00732764711512845,-0.00744606960650450,-0.00755774123720410,-0.00766265915474326,-0.00776082068086891,-0.00785222331130346,-0.00793686471551478,-0.00801474273648681,-0.00808585539052313,-0.00815020086705210,-0.00820777752845768,-0.00825858390992689,-0.00830261871929987,-0.00833988083696080,-0.00837036931572058,-0.00839408338072858,-0.00841102242940049,-0.00842118603136331,-0.00842457392840393,-0.00842118603445595,-0.00841102243558724,-0.00839408339000453,-0.00837036932808503,-0.00833988085240899,-0.00830261873782676,-0.00825858393152670,-0.00820777755312535,-0.00815020089477868,-0.00808585542130112,-0.00801474277030690,-0.00793686475236595,-0.00785222335117495,-0.00776082072374789,-0.00766265920061788,-0.00755774128606030,-0.00744606965832600,-0.00732764716990029,-0.00720247684776492,-0.00707056189368583,-0.00693190568451509,-0.00678651177250505,-0.00663438388563789,-0.00647552592798129,-0.00630994198004180,-0.00613763629914867,-0.00595861331984626,-0.00577287765430549,-0.00558043409274339,-0.00538128760386656,-0.00517544333532200,-0.00496290661416964,-0.00474368294736133,-0.00451777802224395,-0.00428519770706825,-0.00404594805151813,-0.00380003528725019,-0.00354746582844969,-0.00328824627240128,-0.00302238340006705,-0.00274988417668933,-0.00247075575239297,-0.00218500546281911,-0.00189264082974849,-0.00159366956176323,-0.00128809955489897,-0.000975938893324307,-0.000657195850030499,-0.000331878887522693,3.34145942913842e-09,0.000338441993225620,0.000683428032397197,0.00103495223115929,0.00139300516850503,0.00175757722946889,0.00212865860434195,0.00250623928788740,0.00289030907853496,0.00328085757757511,0.00367787418833278,0.00408134811534530,0.00449126836351443,0.00490762373726335,0.00533040283967456,0.00575959407162811,0.00619518563092172,0.00663716551139267,0.00708552150202451,0.00754023552020112,0.00800130615257074];
gamma_hw2 = [0.0984314264375620,0.190977795683231,0.277747850346232,0.358854459090568,0.434410951333006,0.504531108536377,0.569329155503851,0.628919751601867,0.683417981913692,0.732939348324394,0.777599760538794,0.817515527033793,0.852803345946075,0.883580295896874,0.909963826754731,0.932071750338307,0.950022231060053,0.963933776512049,0.973925227996549,0.980115751001026,0.982624825620618,0.981572236928825,0.977078065297850,0.969262676670569,0.958246712785126,0.944151081354314,0.927096946200570,0.907205717348909,0.884599041078845,0.859398789937197,0.831727052713187,0.801706124377657,0.769458495987992,0.735106844560198,0.698774022910099,0.660583049465165,0.620657098048580,0.579119487637426,0.536093672096514,0.491703229889605,0.446071853769842,0.399323340450876,0.351581580260749,0.302970546779874,0.253614286465116,0.203636908261682,0.153162573204425,0.102315484010430,0.0512198746646035,-6.93889390390723e-18,-0.0512198747253730,-0.102315484253484,-0.153162573751219,-0.203636909233561,-0.253614287983263,-0.302970548965306,-0.351581583234234,-0.399323344332891,-0.446071858680565,-0.491703235948854,-0.536093679423684,-0.579119496351471,-0.620657108267944,-0.660583061307803,-0.698774036493364,-0.735106860000845,-0.769458513402098,-0.801706143880624,-0.831727074419638,-0.859398813961032,-0.884599067533076,-0.907205746345715,-0.927096977851231,-0.944151115769173,-0.958246750073555,-0.969262716940852,-0.977078108657220,-0.981572283483502,-0.982624875475573,-0.980115804260100,-0.973925284762364,-0.963933836885948,-0.950022295142090,-0.932071818227184,-0.909963898547822,-0.883580371690117,-0.852803425833963,-0.817515611109343,-0.777599848893496,-0.732939441048164,-0.683418079094942,-0.628919853327246,-0.569329261858495,-0.504531219603636,-0.434411067194538,-0.358854579826320,-0.277747976034131,-0.190977926399782,-0.0984315621847577,3.51610832073634e-06,0.104439230250013,0.214987015873292,0.331757814140563,0.454862063486858,0.584409691443911,0.720510106543501,0.863272190301115,1.01280428928366,1.16921420725810,1.33260919742653,1.50309595474421,1.68078060832496,1.86576871393297,2.05816524656270,2.25807459310711,2.46560054511511,2.68084629164065,2.90391441218069,3.13489805027157,3.37391582304026];

   

figure(1)
scatter(v_values(2,:),gamma_tot); hold on
scatter(v_values(1,:),gamma_tot); hold on
plot(vtot_hw2,gamma_hw2); hold on
plot(utot_hw2,gamma_hw2)
title('Load Factor vs Displacement')
xlabel('Displacement (m)')
ylabel('Load Factor')
legend({'Vertical Displacement Arclength Control','Horizontal Displacement Arclength Control', 'Vertical Displacement Displacement Control', 'Horizontal Displacement Displacement Control'})





        